from kivy.app import App
from kivy.uix.widget import Widget
from kivy.uix.image import Image
from kivy.clock import Clock
from kivy.core.window import Window
from kivy.properties import NumericProperty, ListProperty
from kivy.core.audio import SoundLoader
import os

Window.size = (800, 400)

class Fugu(Image):
    velocity_y = NumericProperty(0)
    gravity = -0.5
    jump_power = 15
    on_ground = True

    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.source = "assets/fugu.png"
        self.size_hint = (None, None)
        self.size = (100, 100)
        self.pos = (100, 100)

    def update(self):
        self.y += self.velocity_y
        self.velocity_y += self.gravity
        if self.y <= 100:
            self.y = 100
            self.velocity_y = 0
            self.on_ground = True

    def jump(self):
        if self.on_ground:
            self.velocity_y = self.jump_power
            self.on_ground = False

class Obstacle(Image):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)
        self.source = "assets/bom.png"
        self.size_hint = (None, None)
        self.size = (80, 80)
        self.pos = (Window.width, 100)

    def update(self, dt):
        self.x -= 5
        if self.x < -100 and self.parent:
            self.parent.remove_widget(self)

class Game(Widget):
    obstacles = ListProperty([])

    def __init__(self, **kwargs):
        super().__init__(**kwargs)

        # çµ¶å¯¾ãƒ‘ã‚¹ã‚’ã‚¯ãƒ©ã‚¹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ä¿æŒï¼ˆã©ã“ã§ã‚‚ä½¿ãˆã‚‹ï¼‰
        self.base_path = os.path.dirname(__file__)

        # èƒŒæ™¯
        self.background = Image(
            source=os.path.join(self.base_path, "assets", "game.png"),
            allow_stretch=True,
            keep_ratio=False,
            size=Window.size,
            pos=(0, 0)
        )
        self.add_widget(self.background)

        # ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
        self.fugu = Fugu()
        self.add_widget(self.fugu)

        # BGM
        bgm_path = os.path.join(self.base_path, "assets", "bgm.ogg")
        self.bgm = SoundLoader.load(bgm_path)
        if self.bgm:
            self.bgm.loop = True
            self.bgm.volume = 0.5
            self.bgm.play()
        else:
            print("âŒ BGMãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:", bgm_path)

        Clock.schedule_interval(self.update, 1 / 120.0)
        Clock.schedule_interval(self.spawn_obstacle, 2.0)

    def play_sfx(self, filename):
        path = os.path.join(self.base_path, "assets", filename)
        sound = SoundLoader.load(path)
        if sound:
            sound.play()
        else:
            print("âŒ åŠ¹æžœéŸ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—:", path)

    def update(self, dt):
        self.fugu.update()

        for obs in list(self.obstacles):
            obs.update(dt)
            if self.check_collision(self.fugu, obs):
                print("ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ðŸ¡ðŸ’¥")

                # BGMåœæ­¢
                if self.bgm:
                    self.bgm.stop()

                # å³æ™‚ã®ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åŠ¹æžœéŸ³
                self.play_sfx("GB__.ogg")

                # 2.5ç§’å¾Œã«ãƒ¡ãƒ¡éŸ³ã‚’å†ç”Ÿï¼ˆClockã§é…å»¶ã€sleepã¯ä½¿ã‚ãªã„ï¼‰
                Clock.schedule_once(lambda _dt: self.play_sfx("meme.ogg"), 2.5)

                # ãƒ«ãƒ¼ãƒ—åœæ­¢
                Clock.unschedule(self.update)
                Clock.unschedule(self.spawn_obstacle)

                # éšœå®³ç‰©ã‚’æŽƒé™¤
                for o in list(self.obstacles):
                    if o.parent:
                        o.parent.remove_widget(o)
                self.obstacles.clear()

                break  # ä¸€åº¦ã®è¡çªã§å‡¦ç†æ‰“ã¡åˆ‡ã‚Š

    def spawn_obstacle(self, dt):
        obs = Obstacle()
        self.obstacles.append(obs)
        self.add_widget(obs)

    def check_collision(self, fugu, obs):
        return (
            fugu.x < obs.x + obs.width and
            fugu.x + fugu.width > obs.x and
            fugu.y < obs.y + obs.height and
            fugu.y + fugu.height > obs.y
        )

    def on_touch_down(self, touch):
        self.fugu.jump()

class FuguRunnerApp(App):
    def build(self):
        return Game()

if __name__ == "__main__":
    FuguRunnerApp().run()